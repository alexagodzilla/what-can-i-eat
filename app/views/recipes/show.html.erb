<div class="container my-3">
  <div class="back-button">
    <%= link_to :back do %>
      <span>
        <i class="fa-solid fa-chevron-left"></i>
        <span>Back</span>
      </span>
    <% end %>
  </div>
  <h2 style= "margin-bottom: 22px;"><%= @recipe.title %></h2>
  <div class="modal-body row pic-friends">
    <div class="col-md-6">
      <div class="recipe-image">
        <%= image_tag @recipe.image_url, alt: "Image of recipe" %>
      </div>

      <div class="bookmarks">
        <% if user_signed_in? %>
          <%= form_with model: [@recipe, @bookmark] do |f| %>
            <% if !Bookmark.where(user: current_user, recipe: @recipe).present? %>
              <%= f.button class: "btn-bookmark" do %>
                <i class="fa-regular fa-bookmark" ></i>
              <% end %>
            <% end %>
          <% end %>
          <% @user_bookmarks.each do |bookmark| %>
            <% if bookmark.recipe == @recipe %>
              <%= link_to bookmark_path(bookmark), data: { turbo_method: :delete } do %>
                <i class="fa-solid fa-bookmark"></i>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
        <% if user_signed_in? == false %>
          <%= link_to new_user_registration_path do %>
            <i class="fa-regular fa-bookmark" ></i>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="col-md-6" class="friends-chat">
      <div class="friends ">
        <% if user_signed_in? %>
          <% selected_users = [] %>
          <% current_user.friends.each do |user| %>
            <% @recipe_ingredients = @recipe.ingredients.pluck(:id) - current_user.ingredients.pluck(:id) %>
            <% selected_users << user if @recipe_ingredients.any? { |id| user.ingredients.pluck(:id).include?(id) } %>
        <% end %>
          <% selected_users.each do |user| %>
              <%= image_tag (user.image_url.present? ? user.image_url : "https://source.unsplash.com/200x200/?user"), class:"avatar-friends" %>
              <%= user.first_name.capitalize %> might have<% user.ingredients.each do |ingredient| %>
                <% if @recipe_ingredients.include?(ingredient.id) %>
                  <span id="friends-ingredients"><%= ingredient.name.downcase %></span>
                <% end %>
              <% end %>in their pantry
              <br>
          <% end %>
        <% end %>
      </div>
      <div class="chat">
        <% if user_signed_in? && selected_users.any? %>
          <%= link_to "Chat", chatroom_path(@chatroom), class: "btn btn-primary chat-to-friends" %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="diet-serving-time">
    <div class="diet">
      <%= "Vegetarian" if @recipe.vegetarian? %>
      <%= "Vegan" if @recipe.vegan? %>
      <%= "Gluten-free" if @recipe.gluten_free? %>
      <%= "Dairy-free" if @recipe.dairy_free? %>
    </div>
    <div class="serving-size">
      <p><i class="fa-solid fa-users me-3"></i><%= @recipe.serving_size %></p>
    </div>
    <div class="total-time">
      <p><i class="fa-solid fa-clock me-3"></i><%= minutes_to_hour(@recipe.total_time) %></p>
    </div>
  </div>

  <div class="modal-body row recipe-details">
    <div class="col-md-4 ingredients">
      <h3>Ingredients</h3>
      <ul>
        <% @recipe.ingredients.each do |ingredient| %>
          <% recipe_ingredient = RecipeIngredient.find_by(recipe: @recipe, ingredient: ingredient) %>
          <li>
            <span><%= truncate_zero(recipe_ingredient.quantity) %>
            <%= ingredient.quantity_unit %></span> <%= ingredient.name %>
          </li>
        <% end %>
      </ul>
    </div>
    <div class="col-md-8 method">
      <h3>Method</h3>
      <% if @recipe.steps.empty? %>
        <p><%= @recipe.instructions %></p>
      <% else %>
        <% @recipe.steps.each do |step| %>
          <p><b>Step <%= step.number %></b></p>
          <p><%= step.content %></p>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="reviews" data-controller="insert-comment" data-insert-comment-position-value="afterbegin">
    <div id="comment-submission">
      <h3>Leave a comment or rating (<%= @recipe.reviews.count %>)</h3>
      <%= render 'recipes/form', recipe: @recipe, review: @review %>
    </div>
    <% if @recipe.reviews.empty? %>
      <p>There are no currently no comments... Leave one now!</p>
    <% else %>
      <% @recipe.reviews.each do |review| %>
        <%= render "recipes/review", recipe: @recipe, review: review %>
      <% end %>
    <% end %>
  </div>

</div>
